<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>채팅</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 CDN 추가 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios CDN 추가 (API 통신용) -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="flex h-screen">
        <!-- 좌측 사이드바 - 채팅 목록 -->
        <div class="w-64 bg-gray-800 text-white p-4 flex flex-col">
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-2">채팅 목록</h2>
                <button @click="createNewChat" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-md text-sm">
                    + 새 채팅
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <ul class="space-y-2">
                    <li v-for="session in chatSessions" :key="session.id">
                        <a href="#" 
                           @click.prevent="loadChatSession(session.id)"
                           class="block p-2 rounded-md hover:bg-gray-700"
                           :class="{'bg-gray-700': currentSession && currentSession.id === session.id}">
                            <div class="text-sm font-medium" v-text="session.title"></div>
                            <div class="text-xs text-gray-400" v-text="formatDate(session.createdAt)"></div>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="pt-4 border-t border-gray-700">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center">
                        <span class="text-sm" v-text="email.charAt(0)"></span>
                    </div>
                    <div class="ml-2">
                        <div class="text-sm font-medium" v-text="email"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메인 채팅 영역 -->
        <div class="flex-1 flex flex-col" v-if="currentSession">
            <!-- 채팅 헤더 -->
            <div class="bg-white border-b p-4">
                <h1 class="text-lg font-semibold" v-text="currentSession.title"></h1>
            </div>

            <!-- 채팅 메시지 영역 -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4" ref="messageArea">
                <!-- 메시지 목록 -->
                <div v-for="message in messages" :key="message.id"
                     :class="message.messageType === 'USER' ? 'flex justify-end' : 'flex justify-start'">
                    <div :class="[
                        'rounded-lg p-3 max-w-lg',
                        message.messageType === 'USER' ? 'bg-blue-500 text-white' : 'bg-gray-100'
                    ]">
                        <p v-text="message.content"></p>
                    </div>
                </div>
            </div>

            <!-- 메시지 입력 영역 -->
            <div class="bg-white border-t p-4">
                <form @submit.prevent="sendMessage" class="flex space-x-4">
                    <input type="text" 
                           v-model="newMessage"
                           class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="메시지를 입력하세요...">
                    <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                        전송
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 채팅 세션이 선택되지 않은 경우 -->
        <div class="flex-1 flex items-center justify-center" v-if="!currentSession">
            <div class="text-center">
                <h2 class="text-xl font-medium text-gray-500">채팅을 선택하거나 새로 시작하세요</h2>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Vue 3 앱 생성
        const { createApp, ref, onMounted } = Vue;
        
        const app = createApp({
            setup() {
                // 반응형 상태 정의
                const email = ref(/*[[${email}]]*/ '');
                const chatSessions = ref(/*[[${chatSessions}]]*/ []);
                const currentSession = ref(null); // 현재 선택된 세션
                const messages = ref([]); // 현재 세션의 메시지 목록
                const newMessage = ref(''); // 새 메시지 입력값
                const messageArea = ref(null); // 메시지 영역 DOM 참조
                
                // 날짜 포맷팅 함수
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                // 채팅 세션 로드 함수
                const loadChatSession = (sessionId) => {
                    // API 호출하여 메시지 목록 가져오기
                    axios.get(`/api/chat/${sessionId}/messages`)
                        .then(response => {
                            messages.value = response.data;
                            currentSession.value = chatSessions.value.find(s => s.id === sessionId);
                            
                            // 스크롤을 맨 아래로 이동
                            setTimeout(() => {
                                if (messageArea.value) {
                                    messageArea.value.scrollTop = messageArea.value.scrollHeight;
                                }
                            }, 0);
                        })
                        .catch(error => {
                            console.error('메시지 로드 중 오류 발생:', error);
                        });
                };
                
                // 새 채팅 생성 함수
                const createNewChat = () => {
                    axios.post('/api/chat/new', {
                        email: email.value,
                        title: '새로운 대화'
                    })
                        .then(response => {
                            const newSession = {
                                id: response.data,
                                title: '새로운 대화',
                                createdAt: new Date().toISOString()
                            };
                            chatSessions.value.push(newSession);
                            loadChatSession(newSession.id);
                        })
                        .catch(error => {
                            console.error('새 채팅 생성 중 오류 발생:', error);
                        });
                };
                
                // 메시지 전송 함수
                const sendMessage = () => {
                    if (!newMessage.value.trim() || !currentSession.value) return;
                    
                    const content = newMessage.value;
                    newMessage.value = ''; // 입력 필드 초기화
                    
                    // 사용자 메시지 추가
                    const userMessage = {
                        id: Date.now(),
                        content: content,
                        messageType: 'USER'
                    };
                    messages.value.push(userMessage);
                    
                    // API 호출하여 메시지 전송
                    axios.post(`/api/chat/${currentSession.value.id}/messages`, { content })
                        .then(response => {
                            // AI 응답 메시지 추가
                            messages.value.push(response.data);
                            
                            // 스크롤을 맨 아래로 이동
                            setTimeout(() => {
                                if (messageArea.value) {
                                    messageArea.value.scrollTop = messageArea.value.scrollHeight;
                                }
                            }, 0);
                        })
                        .catch(error => {
                            console.error('메시지 전송 중 오류 발생:', error);
                        });
                };
                
                // 컴포넌트 마운트 시 초기화
                onMounted(() => {
                    // 초기화는 이미 ref 생성 시점에 Thymeleaf에서 처리됨
                });
                
                // 메서드와 상태 반환
                return {
                    email,
                    chatSessions,
                    currentSession,
                    messages,
                    newMessage,
                    messageArea,
                    formatDate,
                    loadChatSession,
                    createNewChat,
                    sendMessage
                };
            }
        });
        
        // 앱 마운트
        app.mount('#app');
    </script>
</body>
</html> 